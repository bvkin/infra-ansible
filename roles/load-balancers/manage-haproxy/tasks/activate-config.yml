---

# Use a 'block' to ensure "become: True" for all tasks requiring elevated privileges
- block:

  - name: 'Create remote diriectory for validity checking'
    file:
      path: "{{ temp_new_dir }}"
      state: directory

  - name: 'Copy the HAproxy config files to a temp location for validity checking'
    copy:
      src: "{{ item }}"
      dest: "{{ temp_new_dir }}"
    with_fileglob:
      - "{{ haproxy_temp_dir }}/*"
    notify: 'cleanup temp dir'

  - name: 'Get a list of config files'
    find:
      paths: "{{ temp_new_dir }}"
    register: config_files

  - name: 'Build validity command'
    set_fact:
      validity_list: "{{ validity_list | default('')  + ' -f ' + item.path }}"
    with_items: "{{ config_files.files }}"

  - name: 'Check the validity'
    command: 'haproxy -c {{ validity_list }}'
    notify: 'remove tmp new directory'

  - name: 'Copy and activate the HAproxy config files'
    synchronize:
      src: '{{ temp_new_dir }}/'
      dest: '{{ conf_dir }}'
      delete: true
    delegate_to: "{{ inventory_hostname }}"
    #notify: 'reload haproxy'

  - name: 'Open Firewall for LB use (TCP only)'
    firewalld:
      port: "{{ fe.lb_host_port }}/tcp"
      permanent: yes
      state: enabled
      immediate: yes
    loop_control:
      loop_var: fe
    loop: "{{ lb_config.frontends|flatten(levels=1) }}"

  - name: 'Tweak SELinux for LB use (TCP only)'
    seport:
      ports: "{{ fe.lb_host_port }}"
      proto: tcp
      setype: http_port_t
      state: present
    loop_control:
      loop_var: fe
    loop: "{{ lb_config.frontends|flatten(levels=1) }}"

  # End of outer block for "become: True"
  become: True
